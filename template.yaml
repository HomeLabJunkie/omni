kind: Cluster
name: k8s-talos-cluster
labels:
  template: true
  cni: none
  kubespan: enabled
kubernetes:
  version: v1.32.2
talos:
  version: v1.9.4
features:
  enableWorkloadProxy: true
  
patches:
  - name: enable-workload-on-cp
    file: patches/enable-workload-on-cp.yml
  - name: kubespan-enabled
    file: patches/kubespan.yml
  - name: no-cni # we will install cilium in extraManifests
    file: patches/cni.yml
  - name: disable-kubeproxy
    file: patches/disable-kubeproxy.yml
  - name: install-cilium
    file: patches/extraManifests.yml
  - name: metric-server
    file: patches/metrics-server.yml
  # - name: extraMounts for Longhorn
  #   file: patches/longhorn-extra-mounts.yml
  # - name: node-0-disk-sda
  #   file: patches/k8s-node-0-patch.yaml
  # - name: node-1-disk-sda
  #   file: patches/k8s-node-1-patch.yaml
  # - name: node-2-disk-sda
  #   file: patches/k8s-node-2-patch.yaml
  # - name: node-3-disk-sda
  #   file: patches/k8s-node-3-patch.yaml
  # - name: node-4-disk-sda
  #   file: patches/k8s-node-4-patch.yaml
  - kind: machine
    name: k8s-node-5
    patches:
      - name: node-5-disk-sda
#        file: patches/k8s-node-5-patch.yaml
        inline:
          machine:
            kubelet:
              extraMounts:
                - destination: /var/mnt/storage
                  type: bind
                  source: /var/mnt/storage
                  options:
                    - bind
                    - rshared
                    - rw
            disks:
              - device: /dev/sda # The name of the disk to use.
                partitions:
                  - mountpoint: /var/mnt/storage # Where to mount the partition.

systemExtensions:
  - siderolabs/iscsi-tools
  - siderolabs/util-linux-tools
---
kind: Workers
name: workers
labels:
  type: worker
machineClass:
  name: k8s-talos-cluster-workers
  size: unlimited
---
kind: ControlPlane
labels:
  type: control-plane
machineClass:
  name: k8s-talos-cluster-controlplane
  size: 3
